<!DOCTYPE html>
<html>
<head>
    <title>ถ่ายภาพพร้อม GPS และเวลา</title>
    <script src="https://unpkg.com/piexifjs@1.0.6/dist/piexif.min.js"></script>
    <style>
        video, canvas {
            width: 640px;
            height: 480px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <video id="camera-preview" autoplay></video>
    <canvas id="photo-canvas" style="display: none;"></canvas>
    <p id="location-display"></p>
    <button id="capture-button">ถ่ายภาพ</button>
    <button id="download-button" style="display: none;">ดาวน์โหลด</button>

    <script>
        const video = document.getElementById('camera-preview');
        const canvas = document.getElementById('photo-canvas');
        const context = canvas.getContext('2d');
        const captureButton = document.getElementById('capture-button');
        const downloadButton = document.getElementById('download-button');
        const locationDisplay = document.getElementById('location-display');
        let latitude = null;
        let longitude = null;
        let LocTime = null;

        // เข้าถึงกล้อง
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error('Error accessing camera:', error);
            });

        // เข้าถึง GPS
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                locationDisplay.innerHTML = 'Geolocation is not supported by this browser.';
            }
        }

        function showPosition(position) {
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
            LocTime = position.time;
            locationDisplay.innerHTML = `Latitude: ${latitude}<br>Longitude: ${longitude}<br>TS: ${LocTime}`;
        }

        function showError(error) {
            // ... (โค้ดจัดการข้อผิดพลาด)
        }

        function downloadImage(dataURL, filename) {
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ถ่ายภาพ
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ดึงข้อมูล GPS และเวลา
            getLocation();
            const now = new Date();
            const time = now.toLocaleTimeString();
            const date = now.toLocaleDateString();

            // เพิ่มข้อมูลลงใน canvas
            context.fillStyle = 'white';
            context.font = '16px Arial';
            if (latitude && longitude) {
                context.fillText(`Latitude: ${latitude}`, 10, 20);
                context.fillText(`Longitude: ${longitude}`, 10, 40);
            }
            context.fillText(`Time: ${time}`, 10, 60);
            context.fillText(`Date: ${date}`, 10, 80);

            const imageDataURL = canvas.toDataURL('image/jpeg'); // เปลี่ยนเป็น JPEG เพื่อใช้ piexifjs

            // เพิ่มข้อมูล Exif ด้วย piexifjs
            if (latitude && longitude) {
                const exifObj = piexif.load(imageDataURL);
                exifObj['GPS'][piexif.GPSIFD.GPSLatitudeRef] = latitude > 0 ? 'N' : 'S';
                exifObj['GPS'][piexif.GPSIFD.GPSLatitude] = piexif.GPSHelper.degToDmsRational(latitude);
                exifObj['GPS'][piexif.GPSIFD.GPSLongitudeRef] = longitude > 0 ? 'E' : 'W';
                exifObj['GPS'][piexif.GPSIFD.GPSLongitude] = piexif.GPSHelper.degToDmsRational(longitude);
                exifObj['Exif'][piexif.ExifIFD.DateTimeOriginal] = now.toISOString().replace(/T/, ' ').replace(/\..+/, '');
                const exifStr = piexif.dump(exifObj);
                const exifImageDataURL = piexif.insert(exifStr, imageDataURL);
                downloadImage(exifImageDataURL, 'photo.jpg');
            } else {
                downloadImage(imageDataURL, 'photo.jpg');
            }
            downloadButton.style.display = 'block';
        });
        downloadButton.addEventListener('click', () => {
          canvas.toBlob((blob) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'photo.jpg';
            a.click();
            window.URL.revokeObjectURL(url);
          }, 'image/jpeg');
        })
    </script>
</body>
</html>
